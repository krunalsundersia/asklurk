<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripod</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>

<!-- LOGIN/SIGNUP MODAL -->
<div id="auth-modal" class="auth-modal" style="display: flex;">
    <div class="auth-container">
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">Login</button>
            <button class="auth-tab" data-tab="signup">Sign Up</button>
        </div>

        <!-- LOGIN FORM -->
        <div id="login-form" class="auth-form active">
            <h2>Welcome Back</h2>
            <p class="auth-subtitle">Sign in to your account</p>
            
            <button class="google-auth-btn" id="google-login-btn">
                <i class="fab fa-google"></i>
                Continue with Google
            </button>
            
            <div class="divider">
                <span>or</span>
            </div>

            <form id="login-email-form">
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email address" required>
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                <button type="submit" class="auth-submit-btn">Sign In</button>
            </form>

            <div class="auth-links">
                <a href="#" id="forgot-password">Forgot password?</a>
            </div>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signup-form" class="auth-form">
            <h2>Create Account</h2>
            <p class="auth-subtitle">Join Tripod today</p>
            
            <button class="google-auth-btn" id="google-signup-btn">
                <i class="fab fa-google"></i>
                Continue with Google
            </button>
            
            <div class="divider">
                <span>or</span>
            </div>

            <form id="signup-email-form">
                <div class="form-group">
                    <input type="text" id="signup-name" placeholder="Full name" required>
                    <i class="fas fa-user"></i>
                </div>
                <div class="form-group">
                    <input type="email" id="signup-email" placeholder="Email address" required>
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="form-group">
                    <input type="password" id="signup-password" placeholder="Password" required>
                    <i class="fas fa-lock"></i>
                </div>
                <button type="submit" class="auth-submit-btn">Send Verification Code</button>
            </form>
        </div>

        <!-- OTP VERIFICATION FORM -->
        <div id="otp-form" class="auth-form">
            <h2>Verify Your Email</h2>
            <p class="auth-subtitle">We sent a 6-digit code to <span id="otp-email"></span></p>
            
            <form id="otp-verification-form">
                <div class="otp-container">
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                </div>
                <div class="otp-timer">
                    <span id="otp-timer">02:00</span>
                </div>
                <button type="submit" class="auth-submit-btn">Verify & Create Account</button>
            </form>

            <div class="auth-links">
                <a href="#" id="resend-otp">Resend Code</a>
                <a href="#" id="change-email">Change Email</a>
            </div>
        </div>

        <!-- FORGOT PASSWORD FORM -->
        <div id="forgot-password-form" class="auth-form">
            <h2>Reset Password</h2>
            <p class="auth-subtitle">Enter your email to reset your password</p>
            
            <form id="forgot-password-email-form">
                <div class="form-group">
                    <input type="email" id="forgot-password-email" placeholder="Email address" required>
                    <i class="fas fa-envelope"></i>
                </div>
                <button type="submit" class="auth-submit-btn">Send Reset Link</button>
            </form>

            <div class="auth-links">
                <a href="#" id="back-to-login">Back to Login</a>
            </div>
        </div>
    </div>
</div>

<!-- WELCOME SCREEN -->
<div id="welcome-screen" class="welcome-screen">
    <div class="welcome-card">
        <div class="brand">
            <h1>Tripod</h1>
            <p class="subtitle">Your single chat, their combined brilliance</p>
        </div>
        <div class="input-group">
            <textarea id="first-prompt" placeholder="Ask your first question..."></textarea>
            <button id="start-btn" class="send-btn">Ask</button>
        </div>
        <div class="user-menu">
            <button id="logout-btn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
</div>

<!-- MAIN CHAT APP -->
<div id="chat-app" class="chat-app">
    <div class="chat-container">
        <div class="chat-header">
            <h2>Tripod</h2>
            <div class="user-info">
                <span id="user-greeting">Welcome!</span>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="input-bar">
            <textarea id="prompt-input" placeholder="Type your message..."></textarea>
            <button id="ask-btn" class="btn-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
// Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAd8fmdmJM7qAbtuD5gAidIdQ7TX_jbTe0",
  authDomain: "tripod-d7c4a.firebaseapp.com",
  projectId: "tripod-d7c4a",
  storageBucket: "tripod-d7c4a.firebasestorage.app",
  messagingSenderId: "800673305001",
  appId: "1:800673305001:web:f0597d78917b0cc04974b8",
  measurementId: "G-ZP5QQFC43Y"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Authentication state
let currentUser = null;
let otpTimer = null;
let otpTimeLeft = 120;
let pendingSignup = null;

// DOM Elements
const authModal = document.getElementById('auth-modal');
const welcomeScreen = document.getElementById('welcome-screen');
const chatApp = document.getElementById('chat-app');

/* ---------- AUTHENTICATION FUNCTIONS ---------- */
function showAuthForm(formId) {
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    document.getElementById(formId).classList.add('active');
}

function startOTPTimer() {
    otpTimeLeft = 120;
    updateOTPTimer();
    
    otpTimer = setInterval(() => {
        otpTimeLeft--;
        updateOTPTimer();
        
        if (otpTimeLeft <= 0) {
            clearInterval(otpTimer);
        }
    }, 1000);
}

function updateOTPTimer() {
    const minutes = Math.floor(otpTimeLeft / 60);
    const seconds = otpTimeLeft % 60;
    document.getElementById('otp-timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function setupOTPInputs() {
    const otpInputs = document.querySelectorAll('.otp-input');
    
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
    });
}

function showScreen(screen) {
    authModal.style.display = 'none';
    welcomeScreen.style.display = 'none';
    chatApp.style.display = 'none';
    
    if (screen === 'auth') authModal.style.display = 'flex';
    if (screen === 'welcome') welcomeScreen.style.display = 'flex';
    if (screen === 'chat') chatApp.style.display = 'flex';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

/* ---------- FIREBASE AUTHENTICATION ---------- */
// Email/Password Login
document.getElementById('login-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        handleLogin(userCredential.user);
    } catch (error) {
        showNotification(getAuthErrorMessage(error), 'error');
    }
});

// Email/Password Signup - Send OTP
document.getElementById('signup-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    try {
        // Store pending signup data
        pendingSignup = { name, email, password };
        
        // Send OTP to email
        const response = await fetch('/api/auth/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('otp-email').textContent = email;
            showAuthForm('otp-form');
            startOTPTimer();
            showNotification('Verification code sent to your email', 'success');
            // Log OTP for development
            if (data.debug_otp) {
                console.log('OTP:', data.debug_otp);
            }
        } else {
            showNotification(data.error || 'Failed to send OTP', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// OTP Verification
document.getElementById('otp-verification-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const otpInputs = document.querySelectorAll('.otp-input');
    const otp = Array.from(otpInputs).map(input => input.value).join('');
    
    if (otp.length !== 6) {
        showNotification('Please enter 6-digit code', 'error');
        return;
    }
    
    if (!pendingSignup) {
        showNotification('Signup session expired', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/auth/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: pendingSignup.email,
                otp: otp,
                name: pendingSignup.name,
                password: pendingSignup.password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            clearInterval(otpTimer);
            showNotification('Account created successfully!', 'success');
            
            // Sign in the user
            const userCredential = await auth.signInWithEmailAndPassword(
                pendingSignup.email, 
                pendingSignup.password
            );
            handleLogin(userCredential.user);
            
        } else {
            showNotification(data.error || 'Invalid verification code', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// Google Authentication
document.getElementById('google-login-btn').addEventListener('click', handleGoogleAuth);
document.getElementById('google-signup-btn').addEventListener('click', handleGoogleAuth);

function handleGoogleAuth() {
    const provider = new firebase.auth.GoogleAuthProvider();
    
    auth.signInWithPopup(provider)
        .then((result) => {
            handleLogin(result.user);
        })
        .catch((error) => {
            showNotification(getAuthErrorMessage(error), 'error');
        });
}

// Forgot Password
document.getElementById('forgot-password').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('forgot-password-form');
});

document.getElementById('back-to-login').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('login-form');
});

document.getElementById('forgot-password-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('forgot-password-email').value;
    
    try {
        await auth.sendPasswordResetEmail(email);
        showNotification('Password reset link sent to your email', 'success');
        showAuthForm('login-form');
    } catch (error) {
        showNotification(getAuthErrorMessage(error), 'error');
    }
});

// Resend OTP
document.getElementById('resend-otp').addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (!pendingSignup) {
        showNotification('No pending signup found', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/auth/resend-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingSignup.email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            startOTPTimer();
            showNotification('Verification code resent', 'success');
            // Log OTP for development
            if (data.debug_otp) {
                console.log('New OTP:', data.debug_otp);
            }
        } else {
            showNotification('Failed to resend code', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// Change Email
document.getElementById('change-email').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('signup-form');
});

// Logout
document.getElementById('logout-btn').addEventListener('click', () => {
    auth.signOut();
});

function handleLogin(user) {
    currentUser = user;
    showScreen('welcome');
    document.getElementById('user-greeting').textContent = `Welcome, ${user.displayName || user.email}!`;
    showNotification('Login successful!', 'success');
}

function getAuthErrorMessage(error) {
    switch (error.code) {
        case 'auth/invalid-email': return 'Invalid email address';
        case 'auth/user-disabled': return 'This account has been disabled';
        case 'auth/user-not-found': return 'No account found with this email';
        case 'auth/wrong-password': return 'Incorrect password';
        case 'auth/email-already-in-use': return 'An account with this email already exists';
        case 'auth/weak-password': return 'Password should be at least 6 characters';
        case 'auth/network-request-failed': return 'Network error. Please check your connection';
        default: return error.message || 'Authentication failed';
    }
}

// Firebase Auth State Listener
auth.onAuthStateChanged((user) => {
    if (user) {
        handleLogin(user);
    } else {
        currentUser = null;
        showScreen('auth');
    }
});

// Chat functionality
document.getElementById('start-btn').addEventListener('click', function() {
    const firstPrompt = document.getElementById('first-prompt').value.trim();
    if (firstPrompt) {
        // Switch to chat screen
        showScreen('chat');
        
        // Automatically send the first question
        setTimeout(() => {
            document.getElementById('prompt-input').value = firstPrompt;
            sendMessage();
        }, 500);
    } else {
        showNotification('Please enter a question first', 'error');
    }
});

document.getElementById('ask-btn').addEventListener('click', sendMessage);

document.getElementById('prompt-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage() {
    const input = document.getElementById('prompt-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add message to chat
    addMessage(message, 'user');
    input.value = '';
    
    try {
        // Get Firebase token
        const token = await currentUser.getIdToken();
        
        // Send to backend
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            addMessage(data.response, 'assistant');
        } else {
            addMessage('Error: ' + (data.error || 'Failed to get response'), 'error');
        }
    } catch (error) {
        addMessage('Network error. Please try again.', 'error');
    }
}

function addMessage(text, sender) {
    const messages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.textContent = text;
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
}

// Initialize
setupOTPInputs();
showScreen('auth');
</script>
</body>
</html>

