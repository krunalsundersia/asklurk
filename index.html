<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripod - AI Chat Experience</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>

<!-- LOGIN/SIGNUP MODAL -->
<div id="auth-modal" class="auth-modal" style="display: flex;">
    <div class="auth-container">
        <div class="auth-header">
            <div class="brand-logo">
                <i class="fas fa-robot"></i>
                <h1>Tripod</h1>
            </div>
            <p class="tagline">Your single chat, their combined brilliance</p>
        </div>

        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">Login</button>
            <button class="auth-tab" data-tab="signup">Sign Up</button>
        </div>

        <!-- LOGIN FORM -->
        <div id="login-form" class="auth-form active">
            <h2>Welcome Back</h2>
            <p class="auth-subtitle">Sign in to your account</p>
            
            <button class="google-auth-btn" id="google-login-btn">
                <i class="fab fa-google"></i>
                Continue with Google
            </button>
            
            <div class="divider">
                <span>or</span>
            </div>

            <form id="login-email-form">
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-email" placeholder="Email address" required>
                </div>
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-password" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-submit-btn">Sign In</button>
            </form>

            <div class="auth-links">
                <a href="#" id="forgot-password">Forgot password?</a>
            </div>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signup-form" class="auth-form">
            <h2>Create Account</h2>
            <p class="auth-subtitle">Join Tripod today</p>
            
            <button class="google-auth-btn" id="google-signup-btn">
                <i class="fab fa-google"></i>
                Continue with Google
            </button>
            
            <div class="divider">
                <span>or</span>
            </div>

            <form id="signup-email-form">
                <div class="form-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="signup-name" placeholder="Full name" required>
                </div>
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="signup-email" placeholder="Email address" required>
                </div>
                <div class="form-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="signup-password" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-submit-btn">Send Verification Code</button>
            </form>
        </div>

        <!-- OTP VERIFICATION FORM -->
        <div id="otp-form" class="auth-form">
            <h2>Verify Your Email</h2>
            <p class="auth-subtitle">We sent a 6-digit code to <span id="otp-email"></span></p>
            
            <form id="otp-verification-form">
                <div class="otp-container">
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                    <input type="text" class="otp-input" maxlength="1" required>
                </div>
                <div class="otp-timer">
                    <span id="otp-timer">02:00</span>
                </div>
                <button type="submit" class="auth-submit-btn">Verify & Create Account</button>
            </form>

            <div class="auth-links">
                <a href="#" id="resend-otp">Resend Code</a>
                <a href="#" id="change-email">Change Email</a>
            </div>
        </div>

        <!-- FORGOT PASSWORD FORM -->
        <div id="forgot-password-form" class="auth-form">
            <h2>Reset Password</h2>
            <p class="auth-subtitle">Enter your email to reset your password</p>
            
            <form id="forgot-password-email-form">
                <div class="form-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="forgot-password-email" placeholder="Email address" required>
                </div>
                <button type="submit" class="auth-submit-btn">Send Reset Link</button>
            </form>

            <div class="auth-links">
                <a href="#" id="back-to-login">Back to Login</a>
            </div>
        </div>
    </div>
</div>

<!-- WELCOME SCREEN -->
<div id="welcome-screen" class="welcome-screen" style="display: none;">
    <div class="welcome-container">
        <div class="welcome-header">
            <div class="brand">
                <i class="fas fa-robot"></i>
                <h1>Tripod</h1>
            </div>
            <p class="subtitle">Your single chat, their combined brilliance</p>
        </div>
        
        <div class="welcome-content">
            <div class="ai-showcase">
                <div class="ai-model-card">
                    <div class="ai-icon gpt5">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3>GPT-5</h3>
                    <p>Systematic reasoning and comprehensive analysis</p>
                </div>
                <div class="ai-model-card">
                    <div class="ai-icon grok4">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <h3>Grok 4</h3>
                    <p>Creative thinking and innovative solutions</p>
                </div>
                <div class="ai-model-card">
                    <div class="ai-icon deepseek">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Deepseek V3.1</h3>
                    <p>Deep pattern recognition and analysis</p>
                </div>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <textarea id="first-prompt" placeholder="Ask your first question..."></textarea>
                    <button id="start-btn" class="animated-btn">
                        <span class="animated-btn-text">AskLurk</span>
                        <div class="wave"></div>
                    </button>
                </div>
                <p class="input-hint">Press Enter to send, Shift+Enter for new line</p>
            </div>
        </div>
        
        <div class="user-menu">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="user-name">User</span>
            </div>
            <button id="logout-btn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
</div>

<!-- MAIN CHAT APP -->
<div id="chat-app" class="chat-app" style="display: none;">
    <!-- CREATIVE FLOATING TOGGLE -->
    <button id="floating-toggle-btn" class="creative-float-btn" title="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand-mini">
                <i class="fas fa-robot"></i>
                <h2>Tripod</h2>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="history-search" placeholder="Search history..." />
            </div>
            <div class="sidebar-actions">
                <button id="new-chat-btn" class="btn-new-chat" title="Start New Chat">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
                <div class="token-counter" id="token-counter">0 / 300k</div>
                <button id="fullscreen-btn" class="btn-fullscreen" title="Toggle Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button id="theme-toggle-btn" class="btn-theme-toggle" title="Toggle Dark/Light Theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        <div class="history-section">
            <h3><i class="fas fa-history"></i> Recent Conversations</h3>
            <div id="history-list" class="history-list"></div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area" id="main-area">
        <div class="chat-header">
            <div class="chat-title">
                <h2>Tripod</h2>
                <div class="ai-indicators">
                    <div class="ai-indicator gpt5-indicator">
                        <i class="fas fa-brain"></i>
                        <span>GPT-5</span>
                    </div>
                    <div class="ai-indicator grok4-indicator">
                        <i class="fas fa-lightbulb"></i>
                        <span>Grok 4</span>
                    </div>
                    <div class="ai-indicator deepseek-indicator">
                        <i class="fas fa-chart-line"></i>
                        <span>Deepseek</span>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="user-greeting">Welcome!</span>
                <button id="chat-logout-btn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h3>Welcome to Tripod</h3>
                <p>Ask a question to get responses from three AI models simultaneously</p>
                <div class="ai-tags">
                    <span class="ai-tag gpt5-tag">GPT-5</span>
                    <span class="ai-tag grok4-tag">Grok 4</span>
                    <span class="ai-tag deepseek-tag">Deepseek</span>
                </div>
            </div>
        </div>

        <!-- FILE CHIPS BAR -->
        <div id="file-chips" class="file-chips"></div>

        <div class="input-bar">
            <input type="file" id="file-input" multiple accept="image/*,.pdf,.txt,.doc,.docx" style="display:none;">
            <button id="attach-btn" class="attach-btn" title="Add file or picture">
                <i class="fas fa-paperclip"></i>
            </button>

            <div class="input-wrapper">
                <textarea id="prompt-input" placeholder="Type your next thought..." maxlength="1000"></textarea>
                <div class="input-actions">
                    <span class="char-counter">0/1000</span>
                </div>
            </div>
            <button id="ask-btn" class="btn-send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAd8fmdmJM7qAbtuD5gAidIdQ7TX_jbTe0",
  authDomain: "tripod-d7c4a.firebaseapp.com",
  projectId: "tripod-d7c4a",
  storageBucket: "tripod-d7c4a.firebasestorage.app",
  messagingSenderId: "800673305001",
  appId: "1:800673305001:web:f0597d78917b0cc04974b8",
  measurementId: "G-ZP5QQFC43Y"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Authentication state
let currentUser = null;
let otpTimer = null;
let otpTimeLeft = 120;
let pendingSignup = null;

// Chat state
let chatHistory = [];
let isSidebarOpen = true;
let asklurkUsedThisTurn = false;
let selectedFiles = [];
let isFullscreen = false;

// DOM Elements
const authModal = document.getElementById('auth-modal');
const welcomeScreen = document.getElementById('welcome-screen');
const chatApp = document.getElementById('chat-app');
const firstPrompt = document.getElementById('first-prompt');
const startBtn = document.getElementById('start-btn');
const promptInput = document.getElementById('prompt-input');
const askBtn = document.getElementById('ask-btn');
const chatContainer = document.getElementById('chat-container');
const historyList = document.getElementById('history-list');
const newChatBtn = document.getElementById('new-chat-btn');
const sidebar = document.getElementById('sidebar');
const mainArea = document.getElementById('main-area');
const floatingToggleBtn = document.getElementById('floating-toggle-btn');
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const fullscreenBtn = document.getElementById('fullscreen-btn');
const fileInput = document.getElementById('file-input');
const attachBtn = document.getElementById('attach-btn');
const fileChips = document.getElementById('file-chips');
const tokenCounter = document.getElementById('token-counter');
const userGreeting = document.getElementById('user-greeting');
const userName = document.getElementById('user-name');
const charCounter = document.querySelector('.char-counter');

let tokensUsed = 0;

/* ---------- AUTHENTICATION FUNCTIONS ---------- */
function showAuthForm(formId) {
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    document.getElementById(formId).classList.add('active');
}

function startOTPTimer() {
    otpTimeLeft = 120;
    updateOTPTimer();
    
    otpTimer = setInterval(() => {
        otpTimeLeft--;
        updateOTPTimer();
        
        if (otpTimeLeft <= 0) {
            clearInterval(otpTimer);
        }
    }, 1000);
}

function updateOTPTimer() {
    const minutes = Math.floor(otpTimeLeft / 60);
    const seconds = otpTimeLeft % 60;
    document.getElementById('otp-timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function setupOTPInputs() {
    const otpInputs = document.querySelectorAll('.otp-input');
    
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
    });
}

function showScreen(screen) {
    authModal.style.display = 'none';
    welcomeScreen.style.display = 'none';
    chatApp.style.display = 'none';
    
    if (screen === 'auth') authModal.style.display = 'flex';
    if (screen === 'welcome') welcomeScreen.style.display = 'flex';
    if (screen === 'chat') chatApp.style.display = 'flex';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

/* ---------- FIREBASE AUTHENTICATION ---------- */
// Email/Password Login
document.getElementById('login-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        handleLogin(userCredential.user);
    } catch (error) {
        showNotification(getAuthErrorMessage(error), 'error');
    }
});

// Email/Password Signup - Send OTP
document.getElementById('signup-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('signup-name').value;
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    
    try {
        // Store pending signup data
        pendingSignup = { name, email, password };
        
        // Send OTP to email
        const response = await fetch('/api/auth/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('otp-email').textContent = email;
            showAuthForm('otp-form');
            startOTPTimer();
            showNotification('Verification code sent to your email', 'success');
            // Log OTP for development
            if (data.debug_otp) {
                console.log('OTP:', data.debug_otp);
            }
        } else {
            showNotification(data.error || 'Failed to send OTP', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// OTP Verification
document.getElementById('otp-verification-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const otpInputs = document.querySelectorAll('.otp-input');
    const otp = Array.from(otpInputs).map(input => input.value).join('');
    
    if (otp.length !== 6) {
        showNotification('Please enter 6-digit code', 'error');
        return;
    }
    
    if (!pendingSignup) {
        showNotification('Signup session expired', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/auth/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: pendingSignup.email,
                otp: otp,
                name: pendingSignup.name,
                password: pendingSignup.password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            clearInterval(otpTimer);
            showNotification('Account created successfully!', 'success');
            
            // Sign in the user
            const userCredential = await auth.signInWithEmailAndPassword(
                pendingSignup.email, 
                pendingSignup.password
            );
            handleLogin(userCredential.user);
            
        } else {
            showNotification(data.error || 'Invalid verification code', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// Google Authentication
document.getElementById('google-login-btn').addEventListener('click', handleGoogleAuth);
document.getElementById('google-signup-btn').addEventListener('click', handleGoogleAuth);

function handleGoogleAuth() {
    const provider = new firebase.auth.GoogleAuthProvider();
    
    auth.signInWithPopup(provider)
        .then((result) => {
            handleLogin(result.user);
        })
        .catch((error) => {
            showNotification(getAuthErrorMessage(error), 'error');
        });
}

// Forgot Password
document.getElementById('forgot-password').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('forgot-password-form');
});

document.getElementById('back-to-login').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('login-form');
});

document.getElementById('forgot-password-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('forgot-password-email').value;
    
    try {
        await auth.sendPasswordResetEmail(email);
        showNotification('Password reset link sent to your email', 'success');
        showAuthForm('login-form');
    } catch (error) {
        showNotification(getAuthErrorMessage(error), 'error');
    }
});

// Resend OTP
document.getElementById('resend-otp').addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (!pendingSignup) {
        showNotification('No pending signup found', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/auth/resend-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingSignup.email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            startOTPTimer();
            showNotification('Verification code resent', 'success');
            // Log OTP for development
            if (data.debug_otp) {
                console.log('New OTP:', data.debug_otp);
            }
        } else {
            showNotification('Failed to resend code', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
});

// Change Email
document.getElementById('change-email').addEventListener('click', (e) => {
    e.preventDefault();
    showAuthForm('signup-form');
});

// Logout
document.getElementById('logout-btn').addEventListener('click', () => {
    auth.signOut();
});

document.getElementById('chat-logout-btn').addEventListener('click', () => {
    auth.signOut();
});

function handleLogin(user) {
    currentUser = user;
    showScreen('welcome');
    userGreeting.textContent = `Welcome, ${user.displayName || user.email}!`;
    userName.textContent = user.displayName || user.email.split('@')[0];
    showNotification('Login successful!', 'success');
}

function getAuthErrorMessage(error) {
    switch (error.code) {
        case 'auth/invalid-email': return 'Invalid email address';
        case 'auth/user-disabled': return 'This account has been disabled';
        case 'auth/user-not-found': return 'No account found with this email';
        case 'auth/wrong-password': return 'Incorrect password';
        case 'auth/email-already-in-use': return 'An account with this email already exists';
        case 'auth/weak-password': return 'Password should be at least 6 characters';
        case 'auth/network-request-failed': return 'Network error. Please check your connection';
        default: return error.message || 'Authentication failed';
    }
}

/* ---------- CHAT FUNCTIONALITY ---------- */
// Token Counter
function formatTokens(n){
    return n < 1000 ? n : (n/1000).toFixed(1).replace(/\.0$/,'') + 'k';
}

function updateTokenCounter(){
    tokenCounter.textContent = `${formatTokens(tokensUsed)} / 300k`;
}

// Character Counter
function updateCharCounter() {
    const length = promptInput.value.length;
    charCounter.textContent = `${length}/1000`;
    
    if (length > 900) {
        charCounter.style.color = '#ff6b6b';
    } else if (length > 750) {
        charCounter.style.color = '#ffa726';
    } else {
        charCounter.style.color = 'var(--text-secondary)';
    }
}

promptInput.addEventListener('input', updateCharCounter);

// Sidebar Toggle
function toggleSidebar(){
    isSidebarOpen = !isSidebarOpen;
    if (isSidebarOpen){
        sidebar.classList.remove('sidebar-closed');
        mainArea.style.marginLeft = '240px';
        mainArea.style.width = 'calc(100vw - 240px)';
        floatingToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
    }else{
        sidebar.classList.add('sidebar-closed');
        mainArea.style.marginLeft = '0';
        mainArea.style.width = '100vw';
        floatingToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
    }
}

floatingToggleBtn.addEventListener('click', toggleSidebar);

// Fullscreen functionality
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        isFullscreen = true;
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            isFullscreen = false;
        }
    }
}

fullscreenBtn.addEventListener('click', toggleFullscreen);

// Theme Management
function loadTheme(){
    const saved = localStorage.getItem('theme') || 'dark';
    if (saved === 'light') {
        document.body.classList.add('light-theme');
        themeToggleBtn.querySelector('i').className = 'fas fa-sun';
    }
}

function toggleTheme(){
    const isLight = document.body.classList.toggle('light-theme');
    const icon = themeToggleBtn.querySelector('i');
    if (isLight){
        icon.className = 'fas fa-sun';
        localStorage.setItem('theme', 'light');
    }else{
        icon.className = 'fas fa-moon';
        localStorage.setItem('theme', 'dark');
    }
}

loadTheme();
themeToggleBtn.addEventListener('click', toggleTheme);

// History Management
function filterHistory(){
    const q = document.getElementById('history-search').value.toLowerCase().trim();
    document.querySelectorAll('.history-item').forEach(item=>{
        item.style.display = item.title.toLowerCase().includes(q) ? 'flex' : 'none';
    });
}

document.getElementById('history-search').addEventListener('input', filterHistory);

function addToHistory(prompt){
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = `
        <i class="fas fa-message"></i>
        <div class="history-content">
            <span class="history-title">${escapeHtml(prompt.length>40?prompt.substring(0,40)+'…':prompt)}</span>
            <span class="history-time">Just now</span>
        </div>
    `;
    item.title = prompt;
    item.addEventListener('click', ()=>{ promptInput.value = prompt; promptInput.focus(); });
    historyList.prepend(item);
}

// Messages
function appendUserMessage(text){
    const msg = document.createElement('div');
    msg.className = 'message user-message';
    msg.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="message-content">
            <div class="bubble">${escapeHtml(text)}</div>
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    chatContainer.appendChild(msg);
}

function createResponseGroup(){
    const group = document.createElement('div');
    group.className = 'response-group';
    group.innerHTML = `
        <div class="ai-pair">
            <div class="ai-card gpt5-card">
                <div class="card-header">
                    <div class="ai-avatar gpt5-avatar">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="card-title">
                        <h3>GPT-5</h3>
                        <p>Systematic Reasoning</p>
                    </div>
                </div>
                <div class="thinking-container gpt5-thinking">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                    <div class="thinking-text">Reasoning systematically...</div>
                </div>
                <div class="response-display gpt5-response"></div>
            </div>
            <div class="ai-card grok4-card">
                <div class="card-header">
                    <div class="ai-avatar grok4-avatar">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="card-title">
                        <h3>Grok 4</h3>
                        <p>Creative Thinking</p>
                    </div>
                </div>
                <div class="thinking-container grok4-thinking">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                    <div class="thinking-text">Thinking creatively...</div>
                </div>
                <div class="response-display grok4-response"></div>
            </div>
            <div class="ai-card deepseek-card">
                <div class="card-header">
                    <div class="ai-avatar deepseek-avatar">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-title">
                        <h3>Deepseek V3.1</h3>
                        <p>Deep Analysis</p>
                    </div>
                </div>
                <div class="thinking-container deepseek-thinking">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                    <div class="thinking-text">Analyzing deeply...</div>
                </div>
                <div class="response-display deepseek-response"></div>
            </div>
        </div>`;
    return group;
}

function escapeHtml(str){
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

// File Chips
function renderFileChips() {
    fileChips.innerHTML = '';
    selectedFiles.forEach((file, idx) => {
        const chip = document.createElement('div');
        chip.className = 'file-chip';
        const isImage = file.type.startsWith('image/');
        chip.innerHTML = `
            ${isImage ? `<img src="${URL.createObjectURL(file)}" class="chip-img" alt=""/>` : '<i class="fas fa-file"></i>'}
            <span>${file.name}</span>
            <i class="fas fa-times chip-remove" data-idx="${idx}"></i>`;
        fileChips.appendChild(chip);
    });
    fileChips.querySelectorAll('.chip-remove').forEach(icon => {
        icon.onclick = (e) => {
            const idx = parseInt(e.currentTarget.dataset.idx);
            selectedFiles.splice(idx, 1);
            renderFileChips();
        };
    });
}

// File Upload
attachBtn.onclick = () => fileInput.click();
fileInput.onchange = (e) => {
    const files = Array.from(e.target.files);
    selectedFiles.push(...files);
    renderFileChips();
    fileInput.value = '';
};

// AskLurk Feature
function showAskLurkButton(responseGroup) {
    if (asklurkUsedThisTurn) return;
    
    const asklurkRow = document.createElement('div');
    asklurkRow.className = 'asklurk-row';
    asklurkRow.innerHTML = `
        <button class="asklurk-btn">
            <i class="fas fa-crown"></i> AskLurk - Combine All Answers
        </button>
    `;
    
    responseGroup.appendChild(asklurkRow);
    
    const asklurkBtn = asklurkRow.querySelector('.asklurk-btn');
    asklurkBtn.addEventListener('click', () => {
        runAskLurkMerge(responseGroup, asklurkBtn);
    });
}

function runAskLurkMerge(responseGroup, btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Merging Answers...';
    
    // Get all responses
    const gpt5Response = responseGroup.querySelector('.gpt5-response').textContent;
    const grok4Response = responseGroup.querySelector('.grok4-response').textContent;
    const deepseekResponse = responseGroup.querySelector('.deepseek-response').textContent;
    
    // Simulate API call to combine answers
    setTimeout(() => {
        const combinedResponse = combineAIResponses(gpt5Response, grok4Response, deepseekResponse);
        
        // Create AskLurk result card
        const asklurkCard = document.createElement('div');
        asklurkCard.className = 'ai-card asklurk-card';
        asklurkCard.innerHTML = `
            <div class="card-header">
                <div class="ai-avatar asklurk-avatar">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="card-title">
                    <h3>AskLurk Combined Result</h3>
                    <p>Synthesized Intelligence</p>
                </div>
            </div>
            <div class="response-display asklurk-response">
                ${escapeHtml(combinedResponse)}
            </div>
        `;
        
        // Replace the three cards with the AskLurk result
        const aiPair = responseGroup.querySelector('.ai-pair');
        aiPair.innerHTML = '';
        aiPair.appendChild(asklurkCard);
        
        // Remove the AskLurk button
        btn.parentElement.remove();
        
        asklurkUsedThisTurn = true;
        smoothScrollToBottom();
        
    }, 2000);
}

function combineAIResponses(gpt5, grok4, deepseek) {
    // Simulate intelligent combination of responses
    return `Based on the analysis from all three AI models, here's the optimal combined solution:

🔍 **Key Insights from GPT-5**: ${gpt5.split('.')[0]}.

🎨 **Creative Approach from Grok 4**: ${grok4.split('.')[0]}.

🧠 **Deep Analysis from Deepseek**: ${deepseek.split('.')[0]}.

**Final Combined Recommendation**:
After synthesizing all perspectives, the most effective approach combines the logical structure from GPT-5, innovative thinking from Grok 4, and comprehensive analysis from Deepseek. This integrated solution provides both immediate practical steps and long-term strategic advantages.

**Implementation Steps**:
1. Start with the systematic framework suggested by GPT-5
2. Incorporate the creative elements from Grok 4's approach  
3. Apply the deep analytical insights from Deepseek
4. Monitor results and iterate based on performance metrics

This combined approach ensures we leverage the strengths of all three AI models for the most robust solution.`;
}

// Streaming Responses with proper token counting
async function streamResponses(prompt, responseGroup){
    asklurkUsedThisTurn = false;
    
    // Show all thinking containers
    responseGroup.querySelector('.gpt5-thinking').style.display = 'block';
    responseGroup.querySelector('.grok4-thinking').style.display = 'block';
    responseGroup.querySelector('.deepseek-thinking').style.display = 'block';
    
    let gpt5Buf = '', grok4Buf = '', deepseekBuf = '';
    
    try {
        const token = await currentUser.getIdToken();
        const fileUrls = await uploadFiles();
        const payload = { prompt, fileUrls };
        
        const res = await fetch('/api/chat', {
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'Authorization': `Bearer ${token}`
            },
            body:JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error(`Server responded ${res.status} ${res.statusText}`);
        
        const data = await res.json();
        
        // Calculate tokens based on prompt length and response
        const promptTokens = Math.ceil(prompt.length / 4); // Rough estimate
        const responseTokens = Math.ceil(data.response.length / 4);
        const totalTokens = promptTokens + responseTokens;
        
        // Update token usage (multiply by 3 for three AI models)
        tokensUsed += totalTokens * 3;
        updateTokenCounter();
        
        // Simulate streaming for all three models
        simulateGPT5Response(responseGroup, data.response);
        simulateGrok4Response(responseGroup, data.response);
        simulateDeepseekResponse(responseGroup, data.response);
        
    } catch(err) {
        console.error('Stream error:', err);
        responseGroup.querySelectorAll('.response-display').forEach(el=>{
            el.innerHTML = `<div class="error-banner">⚠️ Failed to connect. ${err.message}</div>`;
        });
        responseGroup.querySelector('.gpt5-thinking').style.display = 'none';
        responseGroup.querySelector('.grok4-thinking').style.display = 'none';
        responseGroup.querySelector('.deepseek-thinking').style.display = 'none';
    }
}

// Simulate AI responses with different personalities
function simulateGPT5Response(responseGroup, response) {
    const thinking = responseGroup.querySelector('.gpt5-thinking');
    const display = responseGroup.querySelector('.gpt5-response');
    
    setTimeout(() => {
        thinking.style.display = 'none';
        display.textContent = "As GPT-5, I analyze this systematically: " + response + "\n\nMy approach focuses on logical reasoning and comprehensive analysis of the problem space.";
        smoothScrollToBottom();
        
        // Show AskLurk button when all responses are ready
        if (!responseGroup.querySelector('.grok4-thinking').style.display && 
            !responseGroup.querySelector('.deepseek-thinking').style.display) {
            showAskLurkButton(responseGroup);
        }
    }, 1500);
}

function simulateGrok4Response(responseGroup, response) {
    const thinking = responseGroup.querySelector('.grok4-thinking');
    const display = responseGroup.querySelector('.grok4-response');
    
    setTimeout(() => {
        thinking.style.display = 'none';
        display.textContent = "Grok 4 here! 🤖 Let me approach this creatively: " + response + "\n\nI'm considering unconventional angles and innovative solutions that might not be immediately obvious.";
        smoothScrollToBottom();
        
        // Show AskLurk button when all responses are ready
        if (!responseGroup.querySelector('.gpt5-thinking').style.display && 
            !responseGroup.querySelector('.deepseek-thinking').style.display) {
            showAskLurkButton(responseGroup);
        }
    }, 2500);
}

function simulateDeepseekResponse(responseGroup, response) {
    const thinking = responseGroup.querySelector('.deepseek-thinking');
    const display = responseGroup.querySelector('.deepseek-response');
    
    setTimeout(() => {
        thinking.style.display = 'none';
        display.textContent = "Deepseek V3.1 analyzing: " + response + "\n\nMy analysis involves deep pattern recognition and comprehensive understanding of the underlying concepts and relationships.";
        smoothScrollToBottom();
        
        // Show AskLurk button when all responses are ready
        if (!responseGroup.querySelector('.gpt5-thinking').style.display && 
            !responseGroup.querySelector('.grok4-thinking').style.display) {
            showAskLurkButton(responseGroup);
        }
    }, 2000);
}

async function uploadFiles() {
    if (!selectedFiles.length) return [];
    const token = await currentUser.getIdToken();
    
    const fd = new FormData();
    selectedFiles.forEach(f => fd.append('files', f));
    
    const res = await fetch('/api/upload', { 
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        body: fd 
    });
    
    if (!res.ok) throw new Error('Upload failed');
    const data = await res.json();
    return data.urls || [];
}

// Helpers
function smoothScrollToBottom(){ 
    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'}); 
}

// Chat Flow
async function startChat(prompt){
    if (!prompt?.trim() && !selectedFiles.length) return;
    
    welcomeScreen.style.opacity = '0';
    setTimeout(()=>{ 
        welcomeScreen.style.display='none'; 
        chatApp.style.display='flex'; 
        setTimeout(()=>chatApp.style.opacity='1',50); 
    },300);
    
    // Remove empty state
    const emptyState = document.querySelector('.empty-state');
    if (emptyState) emptyState.remove();
    
    addToHistory(prompt);
    appendUserMessage(prompt + (selectedFiles.length ? ` (+${selectedFiles.length} file${selectedFiles.length>1?'s':''})` : ''));
    
    const group = createResponseGroup();
    chatContainer.appendChild(group);
    smoothScrollToBottom();
    
    firstPrompt.value = '';
    promptInput.focus();
    
    await streamResponses(prompt, group);
}

async function handleAsk(prompt){
    if (!prompt?.trim() && !selectedFiles.length) return;
    
    // Remove empty state
    const emptyState = document.querySelector('.empty-state');
    if (emptyState) emptyState.remove();
    
    addToHistory(prompt);
    appendUserMessage(prompt + (selectedFiles.length ? ` (+${selectedFiles.length} file${selectedFiles.length>1?'s':''})` : ''));
    
    const group = createResponseGroup();
    chatContainer.appendChild(group);
    smoothScrollToBottom();
    
    promptInput.value = '';
    updateCharCounter();
    await streamResponses(prompt, group);
}

function startNewChat(){
    chatContainer.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-robot"></i>
            </div>
            <h3>Welcome to Tripod</h3>
            <p>Ask a question to get responses from three AI models simultaneously</p>
            <div class="ai-tags">
                <span class="ai-tag gpt5-tag">GPT-5</span>
                <span class="ai-tag grok4-tag">Grok 4</span>
                <span class="ai-tag deepseek-tag">Deepseek</span>
            </div>
        </div>
    `;
    selectedFiles = [];
    renderFileChips();
    window.scrollTo(0,0);
    promptInput.focus();
    chatContainer.style.opacity = '0.5';
    setTimeout(()=>chatContainer.style.opacity='1',300);
    document.getElementById('history-search').value = '';
    filterHistory();
    asklurkUsedThisTurn = false;
}

// Event Listeners for Chat
startBtn.addEventListener('click', ()=>startChat(firstPrompt.value));
firstPrompt.addEventListener('keydown', (e)=>{ 
    if(e.key==='Enter' && !e.shiftKey){ 
        e.preventDefault(); 
        startChat(firstPrompt.value); 
    }
});

askBtn.addEventListener('click', ()=>handleAsk(promptInput.value));
promptInput.addEventListener('keydown', (e)=>{ 
    if(e.key==='Enter' && !e.shiftKey){ 
        e.preventDefault(); 
        handleAsk(promptInput.value); 
    }
});

newChatBtn.addEventListener('click', startNewChat);

// Tab switching
document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        showAuthForm(tab.dataset.tab + '-form');
    });
});

// Firebase Auth State Listener
auth.onAuthStateChanged((user) => {
    if (user) {
        handleLogin(user);
    } else {
        currentUser = null;
        showScreen('auth');
    }
});

// Initialize
setupOTPInputs();
showScreen('auth');
updateTokenCounter();
updateCharCounter();
</script>
</body>
</html>
